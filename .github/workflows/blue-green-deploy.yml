# name: éƒ¨ç½²åˆ°æœåŠ¡å™¨

# on:
#   push:
#     branches: [ main ]  # å½“æŽ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
#   workflow_dispatch:    # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµç¨‹

# jobs:
#   build-and-deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#       - name: æ£€å‡ºä»£ç 
#         uses: actions/checkout@v3
#         with:
#           fetch-depth: 0  # èŽ·å–å®Œæ•´çš„ git åŽ†å²
      
#       - name: è®¾ç½® pnpm
#         uses: pnpm/action-setup@v2
#         with:
#           version: 10  # ä½¿ç”¨ pnpm 8.x ç‰ˆæœ¬
      
#       - name: è®¾ç½® Node.js çŽ¯å¢ƒ
#         uses: actions/setup-node@v3
#         with:
#           node-version: '18'
#           cache: 'pnpm'  # ä½¿ç”¨ pnpm ç¼“å­˜
      
#       - name: å®‰è£…ä¾èµ–
#         run: pnpm install --frozen-lockfile
      
#       - name: æž„å»ºé¡¹ç›®
#         run: pnpm build
      
#       - name: è¿è¡Œæµ‹è¯•
#         run: |
#           if grep -q "\"test\":" "package.json"; then
#             pnpm test
#           else
#             echo "æ²¡æœ‰æ‰¾åˆ°æµ‹è¯•è„šæœ¬ï¼Œè·³è¿‡æµ‹è¯•æ­¥éª¤"
#           fi
      
#       - name: æ‰“åŒ…ä¸Šä¼ æ–‡ä»¶
#         run: |
#           # åˆ›å»ºåŒ…å«å¿…è¦æ–‡ä»¶çš„éƒ¨ç½²ç›®å½•
#           mkdir -p deploy
          
#           # å¤åˆ¶ Next.js æž„å»ºäº§ç‰©
#           cp -r .next/standalone/.next deploy/
#           cp -r .next/standalone/src deploy/
#           cp -r .next/standalone/package.json deploy/
#           cp -r .next/static deploy/.next/

#           cp .next/standalone/server.js deploy/
#           cp pnpm-lock.yaml deploy/
          
#           # æ˜¾ç¤ºæ–‡ä»¶å¤¹æ€»å¤§å°
#           echo "éƒ¨ç½²ç›®å½•æ€»å¤§å°ï¼š"
#           du -sh deploy/

#           echo "å¼€å§‹ä¼ è¾“æ–‡ä»¶..."
#           # ç¡®ä¿ .ssh ç›®å½•å­˜åœ¨å¹¶è®¾ç½®æ­£ç¡®æƒé™
#           mkdir -p ~/.ssh
#           chmod 700 ~/.ssh
          
#           # å°† SSH ç§é’¥å†™å…¥ä¸´æ—¶æ–‡ä»¶
#           echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
#           chmod 600 ~/.ssh/id_rsa
          
#           # æ·»åŠ æœåŠ¡å™¨åˆ° known_hosts
#           ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
#           chmod 600 ~/.ssh/known_hosts
          
#           echo "å¼€å§‹ä½¿ç”¨rsyncä¼ è¾“æ–‡ä»¶åˆ°æœåŠ¡å™¨..."
#           if rsync -avz --delete \
#             --exclude='.next/cache/' \
#             --exclude='.next/trace' \
#             --exclude='.next/analyze' \
#             --exclude='.next/standalone/node_modules/' \
#             -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
#             ./deploy/ ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:/tmp/deploy/; then
#             echo "âœ… æ–‡ä»¶ä¼ è¾“æˆåŠŸï¼"
#           else
#             echo "âŒ æ–‡ä»¶ä¼ è¾“å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"
#             exit 1
#           fi

#           # åˆ é™¤ä¸´æ—¶æ–‡ä»¶
#           rm -f ~/.ssh/known_hosts
#           rm -f ~/.ssh/id_rsa
#           echo "æ–‡ä»¶ä¼ è¾“å®Œæˆ"
      

#       - name: é…ç½®æœåŠ¡å™¨å¹¶å¯åŠ¨åº”ç”¨
#         uses: appleboy/ssh-action@master
#         with:
#           host: ${{ secrets.SSH_HOST }}
#           username: ${{ secrets.SSH_USERNAME }}
#           key: ${{ secrets.SSH_PRIVATE_KEY }}
#           port: ${{ secrets.SSH_PORT }}
#           script: |
#             # è®¾ç½®å˜é‡
#             APP_ROOT="${{ secrets.REMOTE_TARGET_DIR }}"
#             TIMESTAMP=$(date +%Y%m%d-%H%M%S)
#             RELEASE_DIR="$APP_ROOT/releases/release-$TIMESTAMP"
#             CURRENT_LINK="$APP_ROOT/current"
            
#             echo "å¼€å§‹è“ç»¿éƒ¨ç½²æµç¨‹..."
            
#             # ç¡®ä¿ç›®å½•ç»“æž„å­˜åœ¨
#             mkdir -p "$RELEASE_DIR" "$APP_ROOT/releases"
            
#             # 1. å¤åˆ¶æ–‡ä»¶åˆ°æ–°å‘å¸ƒç›®å½•
#             echo "ä»Žä¸´æ—¶ç›®å½•å¤åˆ¶æ–‡ä»¶åˆ°æ–°å‘å¸ƒç›®å½•..."
#             rsync -a /tmp/deploy/ "$RELEASE_DIR/"
            
#             # åˆ›å»ºå›žæ»šè„šæœ¬
#             echo "åˆ›å»ºå›žæ»šè„šæœ¬..."
#             cat > "$RELEASE_DIR/rollback.sh" << 'EOF'
#             #!/bin/bash
#             APP_ROOT="${{ secrets.REMOTE_TARGET_DIR }}"
#             CURRENT_LINK="$APP_ROOT/current"
#             RELEASES_DIR="$APP_ROOT/releases"
            
#             # èŽ·å–å½“å‰ç‰ˆæœ¬
#             CURRENT_VERSION=$(basename $(readlink $CURRENT_LINK))
            
#             # èŽ·å–ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼ˆæŒ‰æ—¶é—´æŽ’åºï¼‰
#             PREVIOUS_VERSION=$(ls -1t $RELEASES_DIR | grep -v "$CURRENT_VERSION" | head -1)
            
#             if [ -z "$PREVIOUS_VERSION" ]; then
#               echo "âŒ æ²¡æœ‰æ‰¾åˆ°å¯å›žæ»šçš„ç‰ˆæœ¬ï¼"
#               exit 1
#             fi
            
#             echo "ðŸ”„ æ­£åœ¨å›žæ»šåˆ°ç‰ˆæœ¬: $PREVIOUS_VERSION"
            
#             # åŽŸå­æ“ä½œåˆ‡æ¢ç¬¦å·é“¾æŽ¥
#             ln -sfn "$RELEASES_DIR/$PREVIOUS_VERSION" "$CURRENT_LINK.rollback"
#             mv -T "$CURRENT_LINK.rollback" "$CURRENT_LINK"
            
#             # ä½¿ç”¨PM2é‡æ–°åŠ è½½åº”ç”¨
#             cd $CURRENT_LINK
#             NODE_OPTIONS="--preserve-symlinks" pm2 reload elecmonkey-garden \
#               --update-env --max-memory-restart 768M
            
#             echo "âœ… å›žæ»šå®Œæˆ"
#             exit 0
#             EOF
            
#             chmod +x "$RELEASE_DIR/rollback.sh"
            
#             # 2. åœ¨éžæ´»è·ƒç›®å½•ä¸­å®‰è£…ä¾èµ–
#             cd "$RELEASE_DIR"
#             echo "åœ¨éžæ´»è·ƒç›®å½•å®‰è£…ç”Ÿäº§ä¾èµ–..."
#             pnpm install --prod --frozen-lockfile
            
#             # 3. åŽŸå­æ“ä½œåˆ‡æ¢ç¬¦å·é“¾æŽ¥ - ä»Žéžæ´»è·ƒå˜ä¸ºæ´»è·ƒ
#             echo "åˆ‡æ¢åˆ°æ–°ç‰ˆæœ¬..."
#             ln -sfn "$RELEASE_DIR" "$CURRENT_LINK.new"
#             mv -T "$CURRENT_LINK.new" "$CURRENT_LINK"
            
#             # 4. é‡è½½åº”ç”¨
#             echo "é‡è½½åº”ç”¨..."
#             # cd "$CURRENT_LINK"
            
#             # å¦‚æžœåº”ç”¨ä¸å­˜åœ¨ï¼Œåˆ™é¦–æ¬¡å¯åŠ¨
#             if ! pm2 list | grep -q "elecmonkey-garden"; then
#               echo "é¦–æ¬¡å¯åŠ¨åº”ç”¨..."
#               NODE_OPTIONS="--preserve-symlinks" pm2 start server.js \
#                 --name elecmonkey-garden \
#                 -i 2 \
#                 --time \
#                 --max-memory-restart 768M \
#                 --kill-timeout 5000 \
#                 --no-autorestart \
#                 --no-watch \
#                 --env production \
#                 --update-env \
#                 --cwd "$CURRENT_LINK"
#             else
#               echo "å¹³æ»‘é‡è½½åº”ç”¨..."
#               NODE_OPTIONS="--preserve-symlinks" pm2 reload elecmonkey-garden \
#                 --update-env \
#                 --max-memory-restart 768M \
#                 --kill-timeout 5000 \
#                 --restart-delay=5000
#             fi
            
#             # ä¿å­˜PM2é…ç½®
#             pm2 save
            
#             # ç»™åº”ç”¨ä¸€äº›å¯åŠ¨æ—¶é—´
#             echo "ç­‰å¾…åº”ç”¨å¯åŠ¨..."
#             sleep 5
            
#             # 5. çŽ°åœ¨åˆ›å»ºå¥åº·æ£€æŸ¥è„šæœ¬å¹¶æ‰§è¡Œå¥åº·æ£€æŸ¥
#             echo "åˆ›å»ºå¥åº·æ£€æŸ¥è„šæœ¬..."
#             cat > "$CURRENT_LINK/health-check.sh" << 'EOF'
#             #!/bin/bash
#             MAX_RETRIES=30
#             RETRY_INTERVAL=2
#             APP_URL="http://localhost:3000/api/health"
            
#             echo "å¼€å§‹å¥åº·æ£€æŸ¥..."
            
#             for i in $(seq 1 $MAX_RETRIES); do
#               # è°ƒç”¨å¥åº·æ£€æŸ¥API
#               response=$(curl -s $APP_URL)
#               status=$(echo $response | grep -o '"status":"ok"' || echo "")
              
#               if [ ! -z "$status" ]; then
#                 echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
#                 exit 0
#               else
#                 echo "â³ å°è¯• $i/$MAX_RETRIES: æœåŠ¡å°šæœªå°±ç»ª"
#                 sleep $RETRY_INTERVAL
#               fi
#             done
            
#             echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼è¶…å‡ºæœ€å¤§é‡è¯•æ¬¡æ•°ã€‚"
#             exit 1
#             EOF
#             chmod +x "$CURRENT_LINK/health-check.sh"
            
#             echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
#             if "$CURRENT_LINK/health-check.sh"; then
#               echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ï¼Œéƒ¨ç½²æˆåŠŸå®Œæˆï¼"
#             else
#               echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œæ­£åœ¨å›žæ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬..."
#               "$CURRENT_LINK/rollback.sh"
#               echo "å·²å›žæ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬"
#               exit 1
#             fi
            
#             # 6. éƒ¨ç½²æˆåŠŸåŽï¼Œæ¸…ç†æ—§ç‰ˆæœ¬ï¼Œä¿ç•™æœ€è¿‘5ä¸ª
#             echo "æ¸…ç†æ—§ç‰ˆæœ¬..."
#             cd "$APP_ROOT/releases"
#             ls -1tr | head -n -5 | xargs -r rm -rf
            
#             echo "è“ç»¿éƒ¨ç½²å®Œæˆï¼š$(date)"
            
#             # æ˜¾ç¤ºå½“å‰éƒ¨ç½²çŠ¶æ€
#             echo "å½“å‰PM2çŠ¶æ€:"
#             pm2 status
#             echo "å½“å‰éƒ¨ç½²ç‰ˆæœ¬: $TIMESTAMP"